# Continuous Integration workflow
# Runs on every push and PR to validate the codebase
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.11'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Frontend: Lint, Test, Build
  # ═══════════════════════════════════════════════════════════════════════════
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Validate node registry
        run: npm run validate:nodes

      - name: Type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm run test -- --run

      - name: Build frontend
        run: npm run build

      - name: Build Electron frontend
        run: npm run build:electron

      - name: Verify build outputs
        run: |
          test -f dist/index.html || { echo "::error::dist/index.html not found"; exit 1; }
          test -d dist-electron || { echo "::error::dist-electron not found"; exit 1; }
          echo "Build outputs verified"

  # ═══════════════════════════════════════════════════════════════════════════
  # Backend: Lint, Test, Validate
  # ═══════════════════════════════════════════════════════════════════════════
  backend:
    name: Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Checkout nirs4all library
        uses: actions/checkout@v4
        with:
          repository: GBeurier/nirs4all
          path: nirs4all-lib

      - name: Install nirs4all from source
        run: pip install ./nirs4all-lib

      - name: Lint Python (ruff)
        run: |
          pip install ruff
          ruff check .

      - name: Verify imports
        run: |
          python -c "
          import fastapi
          import uvicorn
          print('FastAPI version:', fastapi.__version__)
          print('Uvicorn version:', uvicorn.__version__)
          print('All imports successful')
          "

      - name: Check syntax
        run: |
          python -m py_compile main.py
          for f in api/*.py; do python -m py_compile "$f"; done
          echo "Syntax check passed"

      - name: Test CLI arguments
        run: |
          python main.py --help
          echo "CLI arguments work"

      - name: Run backend tests
        run: |
          python -m pytest tests/ -v --tb=short --timeout=120 --cov=api --cov-report=xml
        env:
          PYTHONPATH: .

      - name: Smoke test - environment coherence
        run: |
          python -c "
          import sys; sys.path.insert(0, '.')
          from fastapi.testclient import TestClient
          from main import app
          client = TestClient(app)
          r = client.get('/api/system/env-coherence')
          assert r.status_code == 200, f'Coherence endpoint failed: {r.status_code}'
          d = r.json()
          assert 'coherent' in d, 'Missing coherent field'
          assert 'runtime' in d, 'Missing runtime field'
          print(f'Coherence: {d[\"coherent\"]}, Python: {d[\"runtime\"][\"version\"]}')
          "
        env:
          PYTHONPATH: .

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage.xml
          retention-days: 7


  # ═══════════════════════════════════════════════════════════════════════════
  # Electron: Build validation (Linux only for speed)
  # ═══════════════════════════════════════════════════════════════════════════
  electron-build:
    name: Electron Build Test
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libcairo2-dev \
            gir1.2-gtk-3.0 \
            gir1.2-webkit2-4.1 \
            upx-ucl

      - name: Install npm dependencies
        run: npm ci

      - name: Build Electron frontend
        run: npm run build:electron

      - name: Copy backend source files
        run: node scripts/copy-backend-source.cjs --clean

      - name: Verify backend source
        run: |
          test -f backend-dist/main.py || { echo "::error::Backend source not copied"; exit 1; }
          test -d backend-dist/api || { echo "::error::Backend api/ not copied"; exit 1; }
          echo "Backend source ready"

      - name: Test electron-builder (dry-run)
        run: |
          npx electron-builder --linux --dir
          echo "Electron build test passed"

  # ═══════════════════════════════════════════════════════════════════════════
  # Summary
  # ═══════════════════════════════════════════════════════════════════════════
  summary:
    name: CI Summary
    needs: [frontend, backend, electron-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          FRONTEND="${{ needs.frontend.result }}"
          BACKEND="${{ needs.backend.result }}"
          ELECTRON="${{ needs.electron-build.result }}"

          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $([[ $FRONTEND == 'success' ]] && echo '✅' || echo '❌') $FRONTEND |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | $([[ $BACKEND == 'success' ]] && echo '✅' || echo '❌') $BACKEND |" >> $GITHUB_STEP_SUMMARY
          echo "| Electron Build | $([[ $ELECTRON == 'success' ]] && echo '✅' || echo '❌') $ELECTRON |" >> $GITHUB_STEP_SUMMARY

          if [[ "$FRONTEND" != "success" || "$BACKEND" != "success" || "$ELECTRON" != "success" ]]; then
            exit 1
          fi
