# Pre-release validation workflow
# Run this before creating a release tag to validate everything works
name: Pre-Release Validation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to validate (e.g., 1.2.0)'
        required: true
        type: string
      skip_build_test:
        description: 'Skip PyInstaller build test (faster validation)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Validate version format
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 1.0.0, 1.2.3-beta.1)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Check package.json version
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [[ "$PKG_VERSION" != "${{ inputs.version }}" ]]; then
            echo "::warning::package.json version ($PKG_VERSION) differs from release version (${{ inputs.version }})"
            echo "Consider updating package.json before release"
          else
            echo "package.json version matches: $PKG_VERSION"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Frontend tests and build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Validate node registry
        run: npm run validate:nodes

      - name: Run tests
        run: npm run test -- --run

      - name: Build frontend
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/index.html || { echo "::error::dist/index.html not found"; exit 1; }
          echo "Frontend build verified"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: |
            dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Backend validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-backend:
    name: Backend Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies (GTK)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libcairo2-dev \
            gir1.2-gtk-3.0 \
            gir1.2-webkit2-4.1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          python -c "
          import fastapi
          import uvicorn
          import webview
          print('FastAPI version:', fastapi.__version__)
          print('Uvicorn version:', uvicorn.__version__)
          print('PyWebView version:', webview.__version__)
          print('All imports successful')
          "

      - name: Check for syntax errors
        run: |
          python -m py_compile main.py
          for f in api/*.py; do python -m py_compile "$f"; done
          echo "No syntax errors found"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Test PyInstaller build (Linux only for speed)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-build:
    name: Test PyInstaller Build
    needs: [test-frontend, test-backend]
    if: ${{ inputs.skip_build_test == false }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libcairo2-dev \
            gir1.2-gtk-3.0 \
            gir1.2-webkit2-4.1 \
            upx-ucl

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update version.json
        run: |
          cat > version.json << EOF
          {
            "version": "${{ inputs.version }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}"
          }
          EOF
          cat version.json

      - name: Run PyInstaller
        run: |
          pyinstaller nirs4all-webapp.spec --clean --noconfirm

      - name: Verify build output
        run: |
          ls -la dist/nirs4all-webapp/
          test -f dist/nirs4all-webapp/nirs4all-webapp || { echo "::error::Executable not found"; exit 1; }
          test -d dist/nirs4all-webapp/dist || { echo "::error::Frontend dist not bundled"; exit 1; }
          test -f dist/nirs4all-webapp/version.json || { echo "::error::version.json not bundled"; exit 1; }
          echo "Build verification passed"

      - name: Check bundle size
        run: |
          SIZE=$(du -sm dist/nirs4all-webapp | cut -f1)
          echo "Bundle size: ${SIZE} MB"
          if [ "$SIZE" -gt 500 ]; then
            echo "::warning::Bundle size is large (${SIZE} MB). Consider reviewing excludes."
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: Validation Summary
    needs: [validate-version, test-frontend, test-backend, test-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           PRE-RELEASE VALIDATION SUMMARY                      â•‘"
          echo "â•‘           Version: ${{ inputs.version }}                              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          # Collect results
          VERSION_RESULT="${{ needs.validate-version.result }}"
          FRONTEND_RESULT="${{ needs.test-frontend.result }}"
          BACKEND_RESULT="${{ needs.test-backend.result }}"
          BUILD_RESULT="${{ needs.test-build.result }}"

          # Print status
          if [[ "$VERSION_RESULT" == "success" ]]; then
            echo "â•‘  Version validation:  âœ… PASSED                              â•‘"
          else
            echo "â•‘  Version validation:  âŒ FAILED                              â•‘"
          fi

          if [[ "$FRONTEND_RESULT" == "success" ]]; then
            echo "â•‘  Frontend tests:      âœ… PASSED                              â•‘"
          else
            echo "â•‘  Frontend tests:      âŒ FAILED                              â•‘"
          fi

          if [[ "$BACKEND_RESULT" == "success" ]]; then
            echo "â•‘  Backend validation:  âœ… PASSED                              â•‘"
          else
            echo "â•‘  Backend validation:  âŒ FAILED                              â•‘"
          fi

          if [[ "$BUILD_RESULT" == "success" ]]; then
            echo "â•‘  Build test:          âœ… PASSED                              â•‘"
          elif [[ "$BUILD_RESULT" == "skipped" ]]; then
            echo "â•‘  Build test:          â­ï¸  SKIPPED                             â•‘"
          else
            echo "â•‘  Build test:          âŒ FAILED                              â•‘"
          fi

          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          # Final verdict
          ALL_PASSED=true
          if [[ "$VERSION_RESULT" != "success" ]]; then ALL_PASSED=false; fi
          if [[ "$FRONTEND_RESULT" != "success" ]]; then ALL_PASSED=false; fi
          if [[ "$BACKEND_RESULT" != "success" ]]; then ALL_PASSED=false; fi
          if [[ "$BUILD_RESULT" != "success" && "$BUILD_RESULT" != "skipped" ]]; then ALL_PASSED=false; fi

          if [[ "$ALL_PASSED" == "true" ]]; then
            echo "â•‘                                                               â•‘"
            echo "â•‘  ðŸŽ‰ Ready to release!                                         â•‘"
            echo "â•‘                                                               â•‘"
            echo "â•‘  Next steps:                                                  â•‘"
            echo "â•‘  1. Update package.json version to ${{ inputs.version }}              â•‘"
            echo "â•‘  2. Commit changes                                            â•‘"
            echo "â•‘  3. Create and push tag: git tag v${{ inputs.version }}               â•‘"
            echo "â•‘  4. Push tag: git push origin v${{ inputs.version }}                  â•‘"
            echo "â•‘                                                               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "â•‘                                                               â•‘"
            echo "â•‘  âš ï¸  Issues found - fix before releasing                      â•‘"
            echo "â•‘                                                               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
