# Unified Release Workflow
# Produces all distribution formats from a single CI trigger:
#   - Electron installers (Windows NSIS, macOS DMG, Linux AppImage+DEB)
#   - Standalone archives (Windows ZIP, Linux tar.gz)
#   - Docker images (CPU + GPU-CUDA)
#
# Trigger: tag v* or manual dispatch
# Phase 3 (CI/CD Hardening) + Phase 4 (Code Signing & macOS)
name: Release

on:
  push:
    tags:
      - '[0-9]*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., 1.2.0)'
        required: true
        type: string
      skip_standalone:
        description: 'Skip standalone ZIP/tar.gz builds'
        required: false
        default: false
        type: boolean
      skip_docker:
        description: 'Skip Docker image builds'
        required: false
        default: false
        type: boolean

env:
  APP_NAME: nirs4all Studio
  APP_ID: com.nirs4all.webapp
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.11'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Prepare: Extract version, validate, determine build matrix
  # ═══════════════════════════════════════════════════════════════════════════
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      skip_standalone: ${{ steps.flags.outputs.skip_standalone }}
      skip_docker: ${{ steps.flags.outputs.skip_docker }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ -n "${{ inputs.tag }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#v}"

          if [[ "$VERSION" == *-* ]]; then
            PRERELEASE=true
          else
            PRERELEASE=false
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: $PRERELEASE" >> $GITHUB_STEP_SUMMARY

      - name: Determine build flags
        id: flags
        run: |
          echo "skip_standalone=${{ inputs.skip_standalone || 'false' }}" >> $GITHUB_OUTPUT
          echo "skip_docker=${{ inputs.skip_docker || 'false' }}" >> $GITHUB_OUTPUT

  # ═══════════════════════════════════════════════════════════════════════════
  # Installer: Linux x64 (venv-based, Electron + embedded Python)
  # ═══════════════════════════════════════════════════════════════════════════
  installer-linux:
    name: Installer — Linux x64
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libcairo2-dev \
            gir1.2-gtk-3.0 \
            gir1.2-webkit2-4.1

      - name: Install npm dependencies
        run: npm ci

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend (Electron mode)
        run: npm run build:electron

      - name: Copy backend source files
        run: node scripts/copy-backend-source.cjs --clean

      - name: Package with electron-builder
        run: npx electron-builder --linux --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate checksums
        run: |
          cd release
          for f in *.AppImage *.deb; do
            [ -f "$f" ] && sha256sum "$f" > "$f.sha256"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installer-linux-x64
          path: |
            release/*.AppImage
            release/*.deb
            release/*.sha256
            release/*.yml
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Installer: Windows x64 (venv-based, Electron + embedded Python)
  # ═══════════════════════════════════════════════════════════════════════════
  installer-windows:
    name: Installer — Windows x64
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend (Electron mode)
        run: npm run build:electron

      - name: Copy backend source files
        run: node scripts/copy-backend-source.cjs --clean

      # ── Windows Code Signing (Phase 4 — P4-3) ──
      - name: Import code signing certificate
        if: env.WINDOWS_CERT_BASE64 != ''
        env:
          WINDOWS_CERT_BASE64: ${{ secrets.WINDOWS_CERT_BASE64 }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        shell: pwsh
        run: |
          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERT_BASE64)
          [IO.File]::WriteAllBytes("${{ runner.temp }}\cert.pfx", $certBytes)
          echo "CSC_LINK=${{ runner.temp }}\cert.pfx" >> $env:GITHUB_ENV
          echo "CSC_KEY_PASSWORD=$($env:WINDOWS_CERT_PASSWORD)" >> $env:GITHUB_ENV

      - name: Package with electron-builder
        run: npx electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up certificate
        if: always()
        shell: pwsh
        run: Remove-Item "${{ runner.temp }}\cert.pfx" -ErrorAction SilentlyContinue

      - name: Generate checksums
        shell: pwsh
        run: |
          Get-ChildItem release -Include *.exe -Recurse | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)" | Out-File -FilePath "$($_.FullName).sha256" -Encoding ascii -NoNewline
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installer-windows-x64
          path: |
            release/*.exe
            release/*.sha256
            release/*.yml
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Installer: macOS x64 (Intel) — Phase 4: signed + notarized
  # ═══════════════════════════════════════════════════════════════════════════
  installer-macos-x64:
    name: Installer — macOS x64
    needs: prepare
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend (Electron mode)
        run: npm run build:electron

      - name: Copy backend source files
        run: node scripts/copy-backend-source.cjs --clean

      # ── macOS Code Signing (Phase 4 — P4-1) ──
      - name: Import Apple Developer certificate
        if: env.APPLE_CERT_BASE64 != ''
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=${{ runner.temp }}/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERT_BASE64" | base64 --decode > ${{ runner.temp }}/cert.p12
          security import ${{ runner.temp }}/cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

          # Export for electron-builder (keychain-based signing, no file reference needed)
          echo "CSC_KEYCHAIN=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Package with electron-builder
        run: npx electron-builder --mac --arch x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # electron-builder reads these for signing
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # ── macOS Notarization (Phase 4 — P4-2) ──
      - name: Notarize macOS DMG
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG=$(ls release/*.dmg 2>/dev/null | head -1)
          if [ -n "$DMG" ]; then
            echo "Notarizing $DMG..."
            xcrun notarytool submit "$DMG" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait --timeout 600

            echo "Stapling notarization ticket..."
            xcrun stapler staple "$DMG"
            echo "Notarization complete."
          else
            echo "::warning::No DMG found to notarize"
          fi

      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=${{ runner.temp }}/build.keychain
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true

      - name: Generate checksums
        run: |
          cd release
          for f in *.dmg *.zip; do
            [ -f "$f" ] && shasum -a 256 "$f" > "$f.sha256"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installer-macos-x64
          path: |
            release/*.dmg
            release/*.zip
            release/*.sha256
            release/*.yml
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Installer: macOS arm64 (Apple Silicon) — Phase 4: signed + notarized
  # ═══════════════════════════════════════════════════════════════════════════
  installer-macos-arm64:
    name: Installer — macOS arm64
    needs: prepare
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend (Electron mode)
        run: npm run build:electron

      - name: Copy backend source files
        run: node scripts/copy-backend-source.cjs --clean

      # ── macOS Code Signing (Phase 4 — P4-1) ──
      - name: Import Apple Developer certificate
        if: env.APPLE_CERT_BASE64 != ''
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH=${{ runner.temp }}/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERT_BASE64" | base64 --decode > ${{ runner.temp }}/cert.p12
          security import ${{ runner.temp }}/cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

          # Export for electron-builder (keychain-based signing, no file reference needed)
          echo "CSC_KEYCHAIN=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Package with electron-builder
        run: npx electron-builder --mac --arch arm64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # ── macOS Notarization (Phase 4 — P4-2) ──
      - name: Notarize macOS DMG
        if: env.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG=$(ls release/*.dmg 2>/dev/null | head -1)
          if [ -n "$DMG" ]; then
            echo "Notarizing $DMG..."
            xcrun notarytool submit "$DMG" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait --timeout 600

            echo "Stapling notarization ticket..."
            xcrun stapler staple "$DMG"
            echo "Notarization complete."
          else
            echo "::warning::No DMG found to notarize"
          fi

      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=${{ runner.temp }}/build.keychain
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true

      - name: Generate checksums
        run: |
          cd release
          for f in *.dmg *.zip; do
            [ -f "$f" ] && shasum -a 256 "$f" > "$f.sha256"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installer-macos-arm64
          path: |
            release/*.dmg
            release/*.zip
            release/*.sha256
            release/*.yml
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Standalone: Windows x64 (PyInstaller frozen binary, ZIP)
  # ═══════════════════════════════════════════════════════════════════════════
  standalone-windows:
    name: Standalone — Windows x64
    needs: prepare
    if: needs.prepare.outputs.skip_standalone != 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install npm dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-cpu.txt

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend
        run: npm run build

      - name: Write version.json
        shell: pwsh
        run: |
          @{
            version = "${{ needs.prepare.outputs.version }}"
            build_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            commit = "${{ github.sha }}"
          } | ConvertTo-Json | Out-File -FilePath version.json -Encoding utf8

      - name: Build backend with PyInstaller (CPU)
        env:
          NIRS4ALL_BUILD_FLAVOR: cpu
        run: pyinstaller backend.spec --clean --noconfirm

      # ── Windows Code Signing (Phase 4 — P4-3) ──
      - name: Sign standalone executable
        if: env.WINDOWS_CERT_BASE64 != ''
        env:
          WINDOWS_CERT_BASE64: ${{ secrets.WINDOWS_CERT_BASE64 }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        shell: pwsh
        run: |
          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERT_BASE64)
          [IO.File]::WriteAllBytes("${{ runner.temp }}\cert.pfx", $certBytes)

          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" |
            Where-Object { $_.FullName -like "*x64*" } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if ($signtool) {
            & $signtool.FullName sign /f "${{ runner.temp }}\cert.pfx" /p $env:WINDOWS_CERT_PASSWORD `
              /tr http://timestamp.digicert.com /td sha256 /fd sha256 `
              dist/nirs4all-backend.exe
            echo "Executable signed successfully"
          } else {
            echo "::warning::signtool not found, skipping signing"
          }

          Remove-Item "${{ runner.temp }}\cert.pfx" -ErrorAction SilentlyContinue

      - name: Create standalone archive
        shell: pwsh
        run: |
          # Create standalone directory with backend + frontend
          $standaloneDir = "nirs4all-studio-standalone"
          New-Item -ItemType Directory -Path $standaloneDir -Force
          Copy-Item -Path "dist/nirs4all-backend.exe" -Destination "$standaloneDir/"
          Copy-Item -Path "dist/" -Destination "$standaloneDir/dist/" -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "public/" -Destination "$standaloneDir/public/" -Recurse -ErrorAction SilentlyContinue

          # Create launcher script
          @"
          @echo off
          echo Starting nirs4all Studio...
          start "" "%~dp0nirs4all-backend.exe"
          timeout /t 3 /nobreak >nul
          start http://localhost:8000
          "@ | Out-File -FilePath "$standaloneDir/start.cmd" -Encoding ascii

          Compress-Archive -Path $standaloneDir -DestinationPath "nirs4all-Studio-${{ needs.prepare.outputs.version }}-standalone-win-x64.zip"

      - name: Generate checksum
        shell: pwsh
        run: |
          $file = "nirs4all-Studio-${{ needs.prepare.outputs.version }}-standalone-win-x64.zip"
          $hash = (Get-FileHash $file -Algorithm SHA256).Hash.ToLower()
          "$hash  $file" | Out-File -FilePath "$file.sha256" -Encoding ascii -NoNewline

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: standalone-windows-x64
          path: |
            nirs4all-Studio-*.zip
            nirs4all-Studio-*.sha256
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Standalone: Linux x64 (PyInstaller frozen binary, tar.gz)
  # ═══════════════════════════════════════════════════════════════════════════
  standalone-linux:
    name: Standalone — Linux x64
    needs: prepare
    if: needs.prepare.outputs.skip_standalone != 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgirepository1.0-dev \
            libcairo2-dev \
            gir1.2-gtk-3.0 \
            gir1.2-webkit2-4.1 \
            upx-ucl

      - name: Install npm dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-cpu.txt

      - name: Update package.json version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build frontend
        run: npm run build

      - name: Write version.json
        run: |
          cat > version.json << EOF
          {
            "version": "${{ needs.prepare.outputs.version }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}"
          }
          EOF

      - name: Build backend with PyInstaller (CPU)
        run: NIRS4ALL_BUILD_FLAVOR=cpu pyinstaller backend.spec --clean --noconfirm

      - name: Create standalone archive
        run: |
          STANDALONE_DIR="nirs4all-studio-standalone"
          mkdir -p "$STANDALONE_DIR"
          cp dist/nirs4all-backend "$STANDALONE_DIR/"
          cp -r dist/ "$STANDALONE_DIR/dist/" 2>/dev/null || true
          cp -r public/ "$STANDALONE_DIR/public/" 2>/dev/null || true
          chmod +x "$STANDALONE_DIR/nirs4all-backend"

          # Create launcher script
          cat > "$STANDALONE_DIR/start.sh" << 'LAUNCHER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          echo "Starting nirs4all Studio..."
          "$SCRIPT_DIR/nirs4all-backend" &
          BACKEND_PID=$!
          sleep 3
          echo "Open http://localhost:8000 in your browser"
          echo "Press Ctrl+C to stop"
          wait $BACKEND_PID
          LAUNCHER
          chmod +x "$STANDALONE_DIR/start.sh"

          tar -czvf "nirs4all-Studio-${{ needs.prepare.outputs.version }}-standalone-linux-x64.tar.gz" "$STANDALONE_DIR/"

      - name: Generate checksum
        run: |
          FILE="nirs4all-Studio-${{ needs.prepare.outputs.version }}-standalone-linux-x64.tar.gz"
          sha256sum "$FILE" > "$FILE.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: standalone-linux-x64
          path: |
            nirs4all-Studio-*-standalone-linux-x64.tar.gz
            nirs4all-Studio-*-standalone-linux-x64.tar.gz.sha256
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Docker: CPU + GPU-CUDA images
  # ═══════════════════════════════════════════════════════════════════════════
  docker:
    name: Docker Images
    needs: prepare
    if: needs.prepare.outputs.skip_docker != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - variant: cpu
            dockerfile: Dockerfile
            tag_suffix: ''
            build_args: ''
          - variant: gpu-cuda
            dockerfile: Dockerfile
            tag_suffix: '-gpu-cuda'
            build_args: |-
              BASE_IMAGE=nvidia/cuda:12.4.1-runtime-ubuntu22.04
              INSTALL_GPU=true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ghcr.io/gbeurier/nirs4all-studio:${{ needs.prepare.outputs.version }}${{ matrix.tag_suffix }}
            ghcr.io/gbeurier/nirs4all-studio:latest${{ matrix.tag_suffix }}
          build-args: ${{ matrix.build_args }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}
          labels: |
            org.opencontainers.image.title=nirs4all Studio
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # ═══════════════════════════════════════════════════════════════════════════
  # Release: Consolidate all artifacts into GitHub Release
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    name: Create Release
    needs:
      - prepare
      - installer-linux
      - installer-windows
      - installer-macos-x64
      - installer-macos-arm64
      - standalone-windows
      - standalone-linux
      - docker
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( \
            -name "*.AppImage" -o -name "*.deb" -o -name "*.exe" \
            -o -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" \
            -o -name "*.sha256" \
          \) -exec cp {} release/ \; 2>/dev/null || true

          echo "## Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d release ] && [ "$(ls -A release 2>/dev/null)" ]; then
            ls -lh release/ | while read line; do echo "    $line" >> $GITHUB_STEP_SUMMARY; done
          else
            echo "No assets found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate release notes
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Collect job results
          INSTALLER_LINUX="${{ needs.installer-linux.result }}"
          INSTALLER_WINDOWS="${{ needs.installer-windows.result }}"
          INSTALLER_MACOS_X64="${{ needs.installer-macos-x64.result }}"
          INSTALLER_MACOS_ARM64="${{ needs.installer-macos-arm64.result }}"
          STANDALONE_WIN="${{ needs.standalone-windows.result }}"
          STANDALONE_LINUX="${{ needs.standalone-linux.result }}"
          DOCKER="${{ needs.docker.result }}"

          cat > release_notes.md << NOTES
          ## nirs4all Studio ${VERSION}

          ### Installers (Recommended)

          Full desktop application with embedded Python environment and managed dependencies.
          After installation, use the first-launch wizard to configure GPU/framework preferences.

          | Platform | Architecture | File | Status |
          |----------|-------------|------|--------|
          | **Windows** | x64 | \`nirs4all-Studio-${VERSION}-win-x64.exe\` | ${INSTALLER_WINDOWS} |
          | **macOS** | Intel (x64) | \`nirs4all-Studio-${VERSION}-mac-x64.dmg\` | ${INSTALLER_MACOS_X64} |
          | **macOS** | Apple Silicon (arm64) | \`nirs4all-Studio-${VERSION}-mac-arm64.dmg\` | ${INSTALLER_MACOS_ARM64} |
          | **Linux** | x64 | \`nirs4all-Studio-${VERSION}-linux-x64.AppImage\` / \`.deb\` | ${INSTALLER_LINUX} |

          ### Standalone (Portable)

          No installation required. CPU-only, self-contained archive.
          Extract and run — opens in your browser at \`http://localhost:8000\`.

          | Platform | File | Status |
          |----------|------|--------|
          | **Windows** | \`nirs4all-Studio-${VERSION}-standalone-win-x64.zip\` | ${STANDALONE_WIN} |
          | **Linux** | \`nirs4all-Studio-${VERSION}-standalone-linux-x64.tar.gz\` | ${STANDALONE_LINUX} |

          ### Docker

          Server/HPC deployment — no Electron, web UI served by FastAPI.

          \`\`\`bash
          # CPU
          docker pull ghcr.io/gbeurier/nirs4all-studio:${VERSION}
          docker run -p 8000:8000 ghcr.io/gbeurier/nirs4all-studio:${VERSION}

          # GPU (NVIDIA)
          docker pull ghcr.io/gbeurier/nirs4all-studio:${VERSION}-gpu-cuda
          docker run --gpus all -p 8000:8000 ghcr.io/gbeurier/nirs4all-studio:${VERSION}-gpu-cuda
          \`\`\`

          | Variant | Tag | Status |
          |---------|-----|--------|
          | CPU | \`ghcr.io/gbeurier/nirs4all-studio:${VERSION}\` | ${DOCKER} |
          | GPU-CUDA | \`ghcr.io/gbeurier/nirs4all-studio:${VERSION}-gpu-cuda\` | ${DOCKER} |

          ### Verification

          SHA256 checksums are provided as \`.sha256\` files for each download.

          \`\`\`bash
          # Linux/macOS
          sha256sum -c nirs4all-Studio-${VERSION}-linux-x64.AppImage.sha256

          # Windows (PowerShell)
          (Get-FileHash .\nirs4all-Studio-${VERSION}-win-x64.exe).Hash
          \`\`\`

          ### System Requirements

          - **Windows**: Windows 10+ (x64)
          - **macOS**: macOS 12+ (Intel or Apple Silicon)
          - **Linux**: Ubuntu 20.04+ or equivalent (x64)
          - **Docker GPU**: NVIDIA GPU with CUDA 12.x drivers

          ---
          *Commit: ${{ github.sha }}*
          NOTES

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: nirs4all Studio ${{ needs.prepare.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease**: ${{ needs.prepare.outputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Installer Linux | ${{ needs.installer-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Installer Windows | ${{ needs.installer-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Installer macOS x64 | ${{ needs.installer-macos-x64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Installer macOS arm64 | ${{ needs.installer-macos-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Standalone Windows | ${{ needs.standalone-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Standalone Linux | ${{ needs.standalone-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets" >> $GITHUB_STEP_SUMMARY
          ls -1 release/ 2>/dev/null | while read f; do echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY; done || echo "No assets" >> $GITHUB_STEP_SUMMARY
